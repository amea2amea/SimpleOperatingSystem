# 0から作る自作OS
このリポジトリは、0から自作OSを作るための内容をSTEPごとに分けてまとめたものです。
対象のCPUは、RISC-Vのみです。

step0:　QEMU(エミュレータ)の起動
step1:　ブート処理 ( QEMU(RISC-V) -> OpenSBI -> ブート処理 )
step2:	Hello Worldを表示
step3:	トラップ(CPUがOSに対して処理を委譲)の対応
step4:	コンテキストスイッチ
step5:	スレッドのスケジューラ
step6:	プロセス
step7:	ページテーブル

# OSの基本的な仕組み
アプリケーションがOSからいろいろと情報を取得するのと同じようにOSはCPUやBIOSとやり取りを行うことで、作られています。アプリケーションを作るためにOSの仕様を理解するのと同じようにOSの仕組みを知るためにはCPUやBIOSの基本的な仕組みを把握しなければなりません。
そのため、基本的な知識についてまとめていきます。

# コンピュータの起動
コンピュータの起動(電源ON)すると、マザーボードに内蔵されたBIOS (Basic Input/Output System)やUEFI（Unified Extensible Firmware Interface)などのファームウェアを初期化プロセスが動作し、ブートデバイスを決定し、ブートローダを読み込みます。
ブートデバイスのパーティション形式としては、MBR (Master Boot Record)とGPT(GUID Partition Table)があり、
パーティションの先頭にあるセクタからデータを読み込むことで、ブートローダーコードが実行され、オペレーティングシステムが起動します。
* 一般的にBIOSであれば、MBRが採用され、UEFIであれば、GPTが採用されます。

具体的には次のような順番で起動します。
(1) BIOSやUEFIの起動
(2) ブートデバイスの選択
(3) MBR(GPT)の読み込み
(4) MBR(GPT)の実行

[BIOS (Basic Input/Output System)]
x86アーキテクチャで使用されているファームウェアの形態であり、コンピュータの起動時に実行され、ハードウェアとソフトウェアの間の通信を仲介する役割を果たします。具体的には、起動したPCにどんな機器が接続されているかを認識し、ハードウェアの初期化やOSへのサービスの提供なとを行います。現在は、x86アーキテクチャでは、UEFIが使用されており、BIOSは使用されておりません。

[UEFI（Unified Extensible Firmware Interface)]
1999年にインテルが発表したEFI(Extensible Firmware Interface)が元となっており、これを拡張して旧BIOSとの互換性を高め、2005年にUEFIへと発展しました。UEFIの仕様はAMD、AMI、Apple、Dell、HP、IBM、Intel、Lenovo、Microsoft、Phoenix Technologiesなど、140 社以上の主要テクノロジー企業が参加する業界団体「UEFIフォーラム」にて決められています。
x86アーキテクチャ向けに設計されたファームウェアIFであり、ハードウェアの初期化やOS起動を管理し、多くの高度な機能を提供します。
UEFIの仕様はハードウェアに依存しないため、コードが異なるCPUアーキテクチャでも動作させることが可能です。

[MBR (Master Boot Record)]
MBRディスクの先頭にあるセクタをMBRセクタと言います。このセクタのサイズは512バイトとなり、マスターブートコード(446バイト)とディスクパーティションエントリテーブル(DPT、64バイト)とブートサイン(2バイト)を含んでいます。これらの情報は現在使用中のディスクの組織を記録しています。

[GPT(GUID Partition Table)]
GPTディスクの先頭にある(1番目の)セクタもMBRセクタと言います。古いMBRベースのシステムやソフトウェア(例えば、古いOSなど)がGPTデバイスを認識し、正しく使用できるようにするため、保護MBRとして設定してあり、古いブートプロセスが維持できるようなっております。
2番目のセクタには、プライマリーGUIDパーティションテーブルヘッダーが保存されています。これは、パーティションテーブルからなるパーティションエントリーの場所とサイズ情報と、巡回冗長検査（CRC32）のチェックサムが内包されています。

[OpenSBI]
OpenSBIは、RISC-Vアーキテクチャのプロセッサ向けのファームウェアである。SBI(Supervisor Binary Interface)を実装したものである。
SBIは、RISC-Vプロセッサの初期化やシステムレベルの機能を提供し、ブートローダーとして機能する

# CPU
現在のCPUは、非常に複雑なものになっておりますが、ソフトウェアエンジニアとしては、基本的な機能だけ把握しておけば、問題ありません。
具体的には、フェッチサイクルという命令実行サイクルやトラップという割り込み処理などを理解する必要があります。
また、CPUには、各種それぞれの仕様があり、オペコード(命令)の違いや同じC言語のコードでも吐き出されるアセンブリが異なることを理解しておく必要があります。本などで説明されている仕組みは、特定のCPUアーキテクチャの話であり、全てのCPUに適用できるわけではありません。

[混乱する仕様]
表記の違いがある < AT&T記法(GAS) / インテル記法(NASM,MASM) >
CPUによりレジスタや命令が異なる
C言語のソースが同じでもCPUにより吐き出されるアセンブリコードは異なる
CISCとRISCがある
* これらの違いがあるのに書籍等には1つしかないように書かれているものが多い

[フェッチサイクル]
命令フェッチ(読み取り)：プログラムカウンタのアドレスにある命令を読み出す
命令デコード(解読)：アセンブリの命令を解読する
命令実行(実行)：アセンブリの命令を実行する
* プログラムカウンタは実行位置を示します。

[基本的な命令]
演算: add / sub (add,sub etc)
代入: move,
レジスタからメモリへ設定 (ストア) : store word (sw,sd etc)
メモリからレジスタへ読み込み（ロード) : load word (lw,ld etc)
ジャンプ : jump and link (jal,jai etc)
条件分岐 : branch not equal (bne,beq bnez etc) / blt (branch less than) / bge(branch greater equal)
* iは、即値を表す。add immediate (addi), load immediate (li)

[レジスタ]
CPU内部で保持する高速記憶領域であり、CPUの演算や制御処理に使用される領域。
レジスタには、一時的に使用する汎用レジスタと制御情報など記憶する制御レジスタがある。
CPUはメモリ上で演算処理やジャンプ処理などができないため、一旦レジスタに情報を確保する必要がある。
<代表的なレジスタ>
sp:スタックポインタ(スタックのトップ)
bp:ベースポインタ/フレームポインタ(関数ごとのスタック開始位置)
ra:関数から戻るアドレスを設定しておく

[CPUモード]
CPUには、最低でも2種類以上の動作モードを持ち、無制限のCPU動作を許モードをカーネルモード(スーパバイザーモード,特権モード)といい、他のモードはユーザーモード(スレーブモード)といわれる

[アセンブリ]
CPUにより吐き出されるアセンブリは異なりますが、吐き出されるアセンブリは次のような流れになっていることが一般的です。C言語やC++,pythonなどそれぞれの言語に流儀があるようにアセンブリにもアセンブリの流儀があるので、それを把握しておく必要があります。
1.	プロローグ:
	•	リターンアドレス（ra）やフレームポインタ（s0）などをスタックに保存する。
	•	スタックポインタ（sp）を調整して、ローカル変数や他の保存するレジスタのためのスペースを確保する。
2.	エピローグ:
	•	スタックからリターンアドレスやフレームポインタを復元する。
	•	スタックポインタを元に戻す。
	•	リターンアドレスにジャンプして、呼び出し元に戻る。

<RISC-V(32bit)の流れ>
1. スタックポインタを更新してスタックフレームを拡張(push)
2. ra(リターンアドレス)とs0(フレームポインタ)をスタックに保存(４バイト目と８バイト目)
3. 関数の処理
4. スタックに保存(４バイト目と８バイト目)していたra(リターンアドレス)とs0(フレームポインタ)を復元
5. スタックポインタを更新してスタックフレームを戻す(pop)

# RISC-V
非営利組織がRISC-V教会により推進されるオープンなRISC命令セットアーキテクチャ（ISA：Instruction Set Architecture）であり、
主な特徴として命令の追加を自由に行えることやライセンス料やロイヤルティーが不要なことである。

* スマホなどのCPUは、ARM社が設計したCPUコアいわゆる「ARMアーキテクチャ」をライセンス購入し、それに各社独自のコアセットやチップセットを付加してARMプロセッサの製造販売を行っている。
* PCのCPUメーカーとしては、インテル、AMDがあり、設計から製造までを行っている。近年のAMDは、TSMCに製造委託しているものもある。

# ページテーブル
